{% extends "layout_with_navbar.html" %}
{%block content %}

<div style="margin-left:auto; margin-right:auto;">
    <form action="" method="POST" id='newpackageform'>
        {{ form.hidden_tag() }}
        <table id="packageTable" class="table order-list">
            <thead>
                <tr>
                    <td>Name</td>
                    <td>Room #</td>
                    <td>Description</td>
                    <td>Perishable</td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        {{ form.name(class="form-control form-control-md") }}
                        <div name='name-error' class="invalid-feedback" style='display:none;'>
                            <span name='name-error'></span>
                        </div>
                    </td>
                    <td>
                        {{ form.room_number(class="form-control form-control-md") }}
                        <div name='room-error' class="invalid-feedback" style='display:none;'>
                            <span name='room-error'></span>
                        </div>
                    </td>
                    <td>
                        {% if form.description.errors %}
                        {{ form.description(class="form-control form-control-md is-invalid") }}
                        <div class="invalid-feedback">
                            {% for error in form.description.errors %}
                            <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                        {% else %}
                        {{ form.description(class="form-control form-control-md") }}
                        {% endif %}
                    </td>
                    <td class="col-sm-2">
                        <input type="checkbox" name="perishable" value="True">
                        <input type="hidden" name="perishable" value="False">
                    </td>
                    <td><a class="deleteRow"></a></td>
                    <td></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4" style="text-align: left;">
                        <input type="button" class="btn btn-lg btn-block " id="addrow" value="Add Row" />
                    </td>
                    <td>
                        {{form.submit(class="form-control form-control-md btn-success")}}
                    </td>
                    <td></td>
                    <!--Blank for styling-->
                </tr>
            </tfoot>
        </table>
    </form>
</div>

<script>
$(document).ready(function() {
    var name_error;
    var room_error;
    var counter = 0;
    var cols = '';

    // cols += '<td></td>';
    cols +=
        '<td> \
            {{ form.name(class="form-control form-control-md") }} \
            <div name="name-error" class="invalid-feedback" style="display:none;"> \
                <span name="name-error"></span> \
            </div> \
        </td>';
    cols +=
        '<td> \
            {{ form.room_number(class="form-control form-control-md") }} \
            <div name="room-error" class="invalid-feedback" style="display:none;"> \
                <span name="room-error"></span> \
            </div> \
        </td>';
    cols +=
        '<td> \
                {% if form.description.errors %} \
                    {{ form.description(class="form-control form-control-md is-invalid") }} \
                    <div class="invalid-feedback"> \
                        {% for error in form.description.errors %} \
                            <span>{{ error }}</span> \
                        {% endfor %} \
                    </div> \
                {% else %} \
                    {{ form.description(class="form-control form-control-md") }} \
                {% endif %} \
            </td>';
    cols +=
        '<td class="col-sm-2"> \
                    <input type="checkbox" name="perishable" value="True"> \
                    <input type="hidden" name="perishable" value="False"> \
                </td>';

    cols += '<td><input type="button" class="ibtnDel btn btn-md btn-danger "  value="Delete"></td>';
    cols += '<td></td>';

    $('#addrow').on('keyup', function(event) {
        // if tab key is pressed
        if (event.which == 9) {
            newRow();
        }
    });

    $('#addrow').on('click', function() {
        newRow();
    });

    function newRow() {
        var newRow = $('<tr>');
        newRow.append(cols);
        $('table.order-list').append(newRow);

        var empTable = document.getElementById('packageTable');
        var trArray = empTable.rows;
        var lastTrElem = trArray[trArray.length - 2];
        var lastTdElem = lastTrElem.firstChild;
        var inputElem = lastTdElem.firstChild;
        inputElem.focus();
    }

    $('table.order-list').on('click', '.ibtnDel', function(event) {
        $(this).closest('tr').remove();
        counter -= 1;
    });

    $(document).on('click', ':checkbox', function() {
        if ($(this).is(':checked')) {
            $(this).next('input').remove();
        }
        else {
            $("<input type='hidden' name='perishable' value='False'>").insertAfter(this);
        }
    });


    // validate that student name entered exists
    $(document).on('focusout','[name="name"]', function(e) {
        var url = "{{ url_for('packages._validate') }}"; // send the form data here. 
        name = $(this).val()
        $.ajax({
            type: 'POST',
            url: url,
            context: this,
            data: {
                name: $(this).val(),
                room_number: $(this).parent().next().children('input').val()
                }
        }).done(function(data) {
            if (data.name_error) {
                name_error = data.name_error
                $(this).addClass('is-invalid');
                $(this).next().show()
                $(this).next().children().text(data.name_error);
                $(this).parent().next().children('div').hide();
            }
            else {
                name_error = '';
                $(this).removeClass('is-invalid');
                $(this).next().hide();
                $(this).val(data.name);
                $(this).parent().next().children('input').val(data.room_number);
                $(this).parent().next().children('input').removeClass('is-invalid');
                $(this).parent().next().children('div').hide();
            }
        });
        e.preventDefault(); // block the traditional submission of the form.
    });

    // validate room number entered
    $(document).on('focusout','[name="room_number"]', function(e) {
        var url = "{{ url_for('packages._validate') }}"; // send the form data here.
        $.ajax({
            type: 'POST',
            url: url,
            context: this,
            data: {
                name: $(this).parent().prev().children('input').val(),
                room_number: $(this).val()
                }
        }).done(function(data) {
            if (data.name_error) {
                return;
            }
            else if (data.room_error) {
                room_error = data.room_error; // assign error to global variable
                $(this).addClass('is-invalid');
                $(this).next().show();
                $(this).next().children().text(data.room_error);
            }
            else {
                room_error = '';
                $(this).removeClass('is-invalid');
                $(this).next().hide();
                $(this).val(data.room_number);
            }
        });
        e.preventDefault(); // block the traditional submission of the form.
    });

    // validate name and room number on submit
    $('#submit').on('click', function(e) {
        if (name_error || room_error) {
            alert("fix errors before submitting")
            e.preventDefault(e);
        }
    });

    // Inject our CSRF token into our AJAX request.
    var csrf_token = '{{ csrf_token() }}';
    $.ajaxSetup({
        beforeSend : function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader('X-CSRFToken', csrf_token);
            }
        }
    });
});
</script>
{% endblock %}